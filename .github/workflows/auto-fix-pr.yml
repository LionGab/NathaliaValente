name: Auto Fix PR

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'NÃºmero da issue para criar PR automÃ¡tico'
        required: true
        type: number

jobs:
  auto-fix-pr:
    # SÃ³ executa se a issue tiver a label "auto-fix" ou "good first issue"
    if: |
      (github.event_name == 'issues' && (
        contains(github.event.issue.labels.*.name, 'auto-fix') ||
        contains(github.event.issue.labels.*.name, 'good first issue') ||
        contains(github.event.issue.labels.*.name, 'enhancement')
      )) || github.event_name == 'workflow_dispatch'
      
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get issue info
        id: issue-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          
          # Pega informaÃ§Ãµes da issue
          ISSUE_DATA=$(gh issue view $ISSUE_NUMBER --json title,body,labels,author)
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
          ISSUE_AUTHOR=$(echo "$ISSUE_DATA" | jq -r '.author.login')
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT
          
          # Sanitiza o tÃ­tulo para nome de branch
          BRANCH_SUFFIX=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g' | cut -c1-50)
          BRANCH_NAME="fix/issue-$ISSUE_NUMBER-$BRANCH_SUFFIX"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create fix branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "${{ steps.issue-info.outputs.branch_name }}"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze issue and create basic fix
        id: create-fix
        run: |
          ISSUE_TITLE="${{ steps.issue-info.outputs.issue_title }}"
          ISSUE_BODY="${{ steps.issue-info.outputs.issue_body }}"
          
          # Cria um arquivo de placeholder para documentar o fix
          mkdir -p .github/issue-fixes
          
          cat > ".github/issue-fixes/issue-${{ steps.issue-info.outputs.issue_number }}.md" << EOF
          # Fix para Issue #${{ steps.issue-info.outputs.issue_number }}
          
          **TÃ­tulo:** $ISSUE_TITLE
          
          **DescriÃ§Ã£o:**
          $ISSUE_BODY
          
          **Status:** Em desenvolvimento
          
          **PrÃ³ximos passos:**
          - [ ] Analisar o problema
          - [ ] Implementar soluÃ§Ã£o
          - [ ] Testar mudanÃ§as
          - [ ] Documentar alteraÃ§Ãµes
          
          **Arquivos que podem precisar de mudanÃ§as:**
          - src/components/ (se for issue de UI)
          - src/lib/ (se for issue de lÃ³gica)
          - src/contexts/ (se for issue de estado)
          - README.md (se for issue de documentaÃ§Ã£o)
          
          ---
          *Este arquivo foi criado automaticamente para rastrear o progresso da correÃ§Ã£o.*
          EOF
          
          # Verifica se Ã© uma issue relacionada a TypeScript
          if echo "$ISSUE_TITLE $ISSUE_BODY" | grep -qi "typescript\|type\|interface"; then
            echo "Detectada issue relacionada ao TypeScript"
            echo "fix_type=typescript" >> $GITHUB_OUTPUT
          # Verifica se Ã© issue de documentaÃ§Ã£o
          elif echo "$ISSUE_TITLE $ISSUE_BODY" | grep -qi "documentation\|readme\|docs\|guide"; then
            echo "Detectada issue de documentaÃ§Ã£o"
            echo "fix_type=documentation" >> $GITHUB_OUTPUT
          # Verifica se Ã© issue de styling/CSS
          elif echo "$ISSUE_TITLE $ISSUE_BODY" | grep -qi "style\|css\|tailwind\|design\|ui"; then
            echo "Detectada issue de styling"
            echo "fix_type=styling" >> $GITHUB_OUTPUT
          else
            echo "Issue geral detectada"
            echo "fix_type=general" >> $GITHUB_OUTPUT
          fi

      - name: Create documentation fix
        if: steps.create-fix.outputs.fix_type == 'documentation'
        run: |
          # Adiciona seÃ§Ã£o de troubleshooting ao README se nÃ£o existir
          if ! grep -q "## Troubleshooting" README.md; then
            cat >> README.md << EOF
          
          ## Troubleshooting
          
          ### Issue #${{ steps.issue-info.outputs.issue_number }}: ${{ steps.issue-info.outputs.issue_title }}
          
          Esta seÃ§Ã£o foi adicionada para abordar a issue reportada.
          
          **SoluÃ§Ã£o sugerida:**
          - Verificar a documentaÃ§Ã£o mais recente
          - Seguir os passos de setup corretamente
          - Reportar problemas no GitHub Issues
          
          EOF
          fi

      - name: Run linting and formatting
        run: |
          npm run lint || echo "Lint warnings encontrados"
          npm run typecheck || echo "TypeScript warnings encontrados"

      - name: Commit changes
        run: |
          git add .
          
          if git diff --staged --quiet; then
            echo "Nenhuma mudanÃ§a para commit, criando commit inicial"
            touch ".github/issue-fixes/.placeholder"
            git add ".github/issue-fixes/.placeholder"
          fi
          
          git commit -m "fix: initial setup for issue #${{ steps.issue-info.outputs.issue_number }}

          Refs: #${{ steps.issue-info.outputs.issue_number }}
          
          - Created tracking file for issue resolution
          - Setup branch for fixing: ${{ steps.issue-info.outputs.issue_title }}
          - Ready for development and testing
          
          Co-authored-by: ${{ steps.issue-info.outputs.issue_author }} <${{ steps.issue-info.outputs.issue_author }}@users.noreply.github.com>"

      - name: Push branch
        run: |
          git push origin "${{ steps.issue-info.outputs.branch_name }}"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.issue-info.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue-info.outputs.issue_title }}"
          FIX_TYPE="${{ steps.create-fix.outputs.fix_type }}"
          
          # Define emoji baseado no tipo
          case $FIX_TYPE in
            "typescript") EMOJI="ğŸ”§" ;;
            "documentation") EMOJI="ğŸ“š" ;;
            "styling") EMOJI="ğŸ¨" ;;
            *) EMOJI="ğŸ›" ;;
          esac
          
          PR_BODY="## $EMOJI Fix para Issue #$ISSUE_NUMBER
          
          **Resolve:** #$ISSUE_NUMBER
          
          ### ğŸ“‹ Resumo
          
          Este PR foi criado automaticamente para resolver a issue: \"$ISSUE_TITLE\"
          
          ### ğŸ” Tipo de correÃ§Ã£o detectado
          
          **Categoria:** \`$FIX_TYPE\`
          
          ### ğŸ“ Status atual
          
          - [x] Branch criada
          - [x] Estrutura inicial configurada
          - [x] Arquivo de rastreamento criado
          - [ ] ImplementaÃ§Ã£o da soluÃ§Ã£o
          - [ ] Testes realizados
          - [ ] DocumentaÃ§Ã£o atualizada
          
          ### ğŸš€ PrÃ³ximos passos
          
          1. **AnÃ¡lise detalhada:** Revisar a issue e entender o problema
          2. **ImplementaÃ§Ã£o:** Desenvolver a soluÃ§Ã£o adequada
          3. **Testes:** Verificar se a correÃ§Ã£o funciona
          4. **Review:** Solicitar revisÃ£o do cÃ³digo
          
          ### ğŸ“ Arquivos relacionados
          
          - \`.github/issue-fixes/issue-$ISSUE_NUMBER.md\` - Rastreamento do progresso
          
          ### ğŸ‘¥ ColaboraÃ§Ã£o
          
          Este PR estÃ¡ pronto para colaboraÃ§Ã£o! ContribuiÃ§Ãµes sÃ£o bem-vindas de:
          - Autor da issue: @${{ steps.issue-info.outputs.issue_author }}
          - Outros desenvolvedores da equipe
          
          ---
          
          *ğŸ¤– Este PR foi criado automaticamente pelo GitHub Actions para facilitar a resoluÃ§Ã£o da issue.*"
          
          gh pr create \
            --title "$EMOJI Fix: $ISSUE_TITLE (resolves #$ISSUE_NUMBER)" \
            --body "$PR_BODY" \
            --base "main" \
            --head "${{ steps.issue-info.outputs.branch_name }}" \
            --label "auto-generated,fix,$FIX_TYPE" \
            --assignee "${{ steps.issue-info.outputs.issue_author }}" \
            --draft=true
          
          # Comenta na issue original
          gh issue comment $ISSUE_NUMBER --body "ğŸ¤– **PR AutomÃ¡tico Criado!**
          
          Um Pull Request foi criado automaticamente para resolver esta issue:
          
          ğŸ”— **Link do PR:** $(gh pr view ${{ steps.issue-info.outputs.branch_name }} --json url --jq .url)
          
          **PrÃ³ximos passos:**
          1. O PR estÃ¡ em modo draft para permitir desenvolvimento
          2. FaÃ§a as mudanÃ§as necessÃ¡rias na branch \`${{ steps.issue-info.outputs.branch_name }}\`
          3. Marque o PR como ready for review quando estiver pronto
          
          VocÃª foi automaticamente atribuÃ­do ao PR para facilitar a colaboraÃ§Ã£o! ğŸš€"
          
          echo "âœ… PR automÃ¡tico criado e issue comentada!"